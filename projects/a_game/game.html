<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>игра</title>
<style>
#info{
	border: 1px solid black;
	height: 800px; /* Высота блока */
	width: 800px; /* Ширина блока */
	/*float: right; /* Обтекание */
	/*display: inline-block;/**/
}
#grafika{
	/*display: inline;/**/
	/*float: left; /* Обтекание */
	/*border: 1px solid black;/**/
	/*height: 800px; /* Высота блока */
	/*width: 1000px; /* Ширина блока */
}

</style>
<script type="text/javascript">
//1.4142135623731 ход на искасок.
var svgns = "http://www.w3.org/2000/svg";
var go_game;

window.onload = function(){
	//должно быть окно для игры <svg xmlns="http://www.w3.org/2000/svg" id="grafika"></svg>
	//или передать ид окна svg в конструктор игры.
	go_game = new Game('grafika');
	go_game.new_game();
}
function Game(id_svg){//Конструктор игры.
	//первичные настройки.
	this.window_width = 1000;
	this.window_height = 800;
	this.svg = document.getElementById(id_svg || 'grafika');
	this.svg.setAttributeNS(null, "width", this.window_width);
	this.svg.setAttributeNS(null, "height", this.window_height);
	//Создаем группу svg
	this.g = document.createElementNS(svgns, "g");
	this.g.setAttributeNS(null, "id", "game");
	this.svg.appendChild(this.g);
	
	//
	this.players = new Array();
	this.map = null;
	//методы.
	this.new_game = function(){
		this.map = new Map(this);
		this.players[this.players.length] = new Player(this,this.players.length,"Ra","#00a");
		this.players[this.players.length-1].add_object(new Hero(this,243));
		this.players[this.players.length] = new Player(this,this.players.length,"Враг","#a00");
		this.players[this.players.length-1].add_object(new Hero(this,76));
		this.players[this.players.length] = new Player(this,this.players.length,"Империя","#aa0");
		this.players[this.players.length-1].add_object(new Hero(this,63));
		this.players[this.players.length] = new Player(this,this.players.length,"Нейтралы","#555");
		this.players[this.players.length-1].add_object(new Hero(this,256));
	}
	this.save_game = function(){
		let save = {};
		save.players = [];
		for(let i = 0; i < this.players.length; i++){
			save.players[i] = this.players[i].save();
		}
		save.map = this.map.save();
		let file = new Blob([JSON.stringify(save)], {type: "text/plain"});
		if (window.navigator.msSaveOrOpenBlob) // IE10+
			window.navigator.msSaveOrOpenBlob(file, "save.sav");
		else { // Others
			let a = document.createElement("a"),
				url = URL.createObjectURL(file);
			a.href = url;
			a.download = "save.sav";
			document.body.appendChild(a);
			a.click();
			setTimeout(function(){
				document.body.removeChild(a);
				window.URL.revokeObjectURL(url);  
			}, 0);
		}
	}
	this.del_game = function(){
		
	}
	this.load_game = function(){
		
	}
	
	
}
function Player(parent,id,name,color){
	//настройки игрока.
	this.parent = parent;
	this.id = id;
	this.name = name;
	this.color = color;
	this.objects = new Array();
	//методы.
	this.add_object = function(object){
		object.color = this.color;
		object.player = this.id;
		this.objects[this.objects.length] = object;
	}
	this.save = function(){
		let player = {};
		player.id = this.id;
		player.name = this.name;
		player.color = this.color;
		return player;
	}
}
function Hero(parent,id_sector){
	this.parent = parent;
	this.size = 30;
	this._color = "#555";
	this.contour_color = "#333";
	this.contour_thickness = 1;
	
	this.picture = document.createElementNS(svgns, "circle");
	
	this.picture.setAttributeNS(null, "r", this.size/2);
	this.picture.setAttributeNS(null, "fill", this._color);
	this.picture.setAttributeNS(null, "stroke", this.contour_color);
	this.picture.setAttributeNS(null, "stroke-width", this.contour_thickness);
	Object.defineProperty(this, "color", {
		get: function(){
			return this._color;
		},
		set: function(value){
			this._color = value;
			this.picture.setAttributeNS(null, "fill", value);
		}
	});
	//методы
	this.place = function(obj){
		this.player = -1;
		this.picture.setAttributeNS(null, "cx", obj.center_x);
		this.picture.setAttributeNS(null, "cy", obj.center_y);
		obj.g.appendChild(this.picture);
		obj.object = this;
	}
	this.place(this.parent.map.sectors[id_sector]);
	this.save = function(){
		let hero = {};
		hero.type = "Hero";
		hero.player = this.player;
		return hero;
	}
}
function Map(parent){
	//настройки карты.
	this.parent = parent;
	this.size_x = 20;
	this.size_y = 16;
	//Создаем группу svg
	this.g = document.createElementNS(svgns, "g");
	this.g.setAttributeNS(null, "id", "map");
	this.parent.g.appendChild(this.g);
	//
	this.sectors = new Array();
	
	let y = 0;
	while(y<this.size_y){
		let x = 0;
		while(x<this.size_x){
			this.sectors[this.sectors.length] = new Sector(this,this.sectors.length,x,y);
			x++;
		}
		y++;
	}
	this.save = function(){
		let map = {};
		map.size_x = this.size_x;
		map.size_y = this.size_y;
		map.sectors = [];
		for(let i = 0; i < this.sectors.length; i++){
			map.sectors[i] = this.sectors[i].save();
		}
		return map;
	}
}
function Sector(parent,id,x,y){
	this.parent = parent;
	this.id = id;
	this.x = x;
	this.y = y;
	this.size = 50;
	this.center_x = this.x*this.size+this.size/2;
	this.center_y = this.y*this.size+this.size/2;
	this.color = "#270";
	this.contour_color = "#333";
	this.contour_thickness = 1;
	this.object = null;
	//Создаем группу svg
	this.g = document.createElementNS(svgns, "g");
	this.g.setAttributeNS(null, "id", "sector"+this.id);
	this.parent.g.appendChild(this.g);
	//
	//Рисуем сектор.
	this.picture = document.createElementNS(svgns, "path");
	this.d = "M "+(this.x*this.size)+" "+(this.y*this.size)+" h "+this.size+" v "+this.size+" h -"+this.size+" z";
	this.picture.setAttributeNS(null, "d", this.d);
	this.picture.setAttributeNS(null, "fill", this.color);
	this.picture.setAttributeNS(null, "stroke", this.contour_color);
	this.picture.setAttributeNS(null, "stroke-width", this.contour_thickness);
	this.g.appendChild(this.picture);
	//
	//методы
	this.save = function(){
		let sector = {};
		sector.id = this.id;
		sector.x = this.x;
		sector.y = this.y;
		sector.color = this.color;
		if(this.object === null)sector.object = this.object;
		else sector.object = this.object.save();
		return sector;
	}
	//
	//test
	this.picture.onclick = function(event){
		info("id = "+this.id+";<br>x = "+this.x+";<br>y = "+this.y+";<br>center_x = "+this.center_x+";<br>center_y = "+this.center_y+";");
	}.bind(this);
	//
}
//####################

function test(){
	go_game.save_game();
	
}
function out(text){
	document.getElementById("output").innerHTML=text;
}
function info(text){
	document.getElementById("info").innerHTML=text;
}
</script>
</head>
<body>
	<table>
		<tr>
			<td>
				<svg xmlns="http://www.w3.org/2000/svg" id="grafika"></svg>
			</td>
			<td>
				<div id="info"></div>
			</td>
		</tr>
	</table>
	<br>
	<input type="button" value="Ход" onClick="xod()">
	<br>
	<input type="button" value="start" onClick="start()">
	<br>
	<input type="button" value="test" onClick="test()">
	<br>
	<input type="button" value="getRandomInRange" onClick="getRandomInRange(1,3)">
	<br>
	<span id="output"></span>
	<br>
	
</body>
</html>
